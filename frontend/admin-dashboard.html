<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | AgriConnect</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-green-50 min-h-screen">
  <!-- Navbar -->
  <nav class="bg-green-700 text-white shadow">
    <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center py-4 px-4 sm:px-6">
      <div class="flex items-center mb-2 sm:mb-0">
        <img src="icon.jpg" alt="Leaf Icon" class="h-10 w-10 mr-2 rounded-full" />
        <span class="text-2xl font-bold tracking-wide">AgriConnect</span>
      </div>
      <ul class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-6 text-lg items-center">
        <li><a href="index.html" class="hover:text-yellow-300 transition">Home</a></li>
        <li><a href="login.html" class="hover:text-yellow-300 transition">Farmers</a></li>
        <li><a href="login.html" class="hover:text-yellow-300 transition">Consumers</a></li>
        <li><a href="about.html" class="hover:text-yellow-300 transition">About</a></li>
        <li><a href="contact.html" class="hover:text-yellow-300 transition">Contact</a></li>
        <li><button id="logoutBtn" class="ml-0 sm:ml-4 bg-yellow-400 hover:bg-green-700 hover:text-white text-green-900 px-4 py-2 rounded transition">Logout</button></li>
      </ul>
    </div>
  </nav>

  <!-- Dashboard Section -->
  <main class="flex-1 container mx-auto px-2 sm:px-4 py-8">
    <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-6">Welcome, Admin!</h2>
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow p-6 text-center">
        <div class="text-2xl font-bold text-green-700 summary-users">0</div>
        <div class="text-green-900">Total Users</div>
      </div>
      <div class="bg-white rounded-lg shadow p-6 text-center">
        <div class="text-2xl font-bold text-green-700 summary-farmers">0</div>
        <div class="text-green-900">Active Farmers</div>
      </div>
      <div class="bg-white rounded-lg shadow p-6 text-center">
        <div class="text-2xl font-bold text-green-700 summary-orders">0</div>
        <div class="text-green-900">Total Orders</div>
      </div>
      <div class="bg-white rounded-lg shadow p-6 text-center">
        <div class="text-2xl font-bold text-green-700 summary-revenue">â‚¹0</div>
        <div class="text-green-900">Revenue</div>
      </div>
    </div>
    <!-- Farmer Verification -->
    <section class="mb-10">
      <h3 class="text-2xl font-semibold text-green-800 mb-4">Verify Farmers</h3>
      <div class="overflow-x-auto mb-4">
        <table class="min-w-full bg-white rounded shadow">
          <thead>
            <tr class="bg-green-100 text-green-900">
              <th class="py-2 px-4">Name</th>
              <th class="py-2 px-4">Location</th>
              <th class="py-2 px-4">Status</th>
              <th class="py-2 px-4">Action</th>
            </tr>
          </thead>
          <tbody id="pendingFarmersTableBody">
            <!-- Data will be loaded here by JavaScript -->
          </tbody>
        </table>
      </div>
    </section>
    <!-- Crop Approval -->
    <section class="mb-10">
      <h3 class="text-2xl font-semibold text-green-800 mb-4">Approve Crops</h3>
      <div class="overflow-x-auto mb-4">
        <table class="min-w-full bg-white rounded shadow">
          <thead>
            <tr class="bg-green-100 text-green-900">
              <th class="py-2 px-4">Image</th>
              <th class="py-2 px-4">Crop</th>
              <th class="py-2 px-4">Farmer</th>
              <th class="py-2 px-4">Status</th>
              <th class="py-2 px-4">Action</th>
            </tr>
          </thead>
          <tbody id="pendingCropsTableBody">
            <!-- Data will be loaded here by JavaScript -->
          </tbody>
        </table>
      </div>
    </section>
    <!-- Available Crops Section -->
    <section class="mb-10">
      <h3 class="text-2xl font-semibold text-green-800 mb-4">Available Crops</h3>
      <div class="overflow-x-auto mb-4">
        <table class="min-w-full bg-white rounded shadow">
          <thead>
            <tr class="bg-green-100 text-green-900">
              <th class="py-2 px-4">Image</th>
              <th class="py-2 px-4">Crop Name</th>
              <th class="py-2 px-4">Farmer</th>
              <th class="py-2 px-4">Quantity</th>
              <th class="py-2 px-4">Price</th>
              <th class="py-2 px-4">Status</th>
            </tr>
          </thead>
          <tbody id="availableCropsTableBody">
            <!-- Data will be loaded here by JavaScript -->
          </tbody>
        </table>
      </div>
    </section>
    <!-- Search/Filter Users -->
    <div class="mb-4 flex flex-wrap gap-4 items-center">
      <input id="userSearchInput" type="text" placeholder="Search by name or email..." class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-400">
      <select id="userRoleFilter" class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-400">
        <option value="">All Roles</option>
        <option value="farmer">Farmer</option>
        <option value="consumer">Consumer</option>
      </select>
    </div>
    <!-- Manage Users Section -->
    <section class="mb-10">
      <h3 class="text-2xl font-semibold text-green-800 mb-4">Manage Users</h3>
      <div class="overflow-x-auto mb-4">
        <table class="min-w-full bg-white rounded shadow">
          <thead>
            <tr class="bg-green-100 text-green-900">
              <th class="py-2 px-4">Name</th>
              <th class="py-2 px-4">Email</th>
              <th class="py-2 px-4">Role</th>
              <th class="py-2 px-4">Status</th>
              <th class="py-2 px-4">Action</th>
            </tr>
          </thead>
          <tbody id="manageUsersTableBody">
            <!-- Data will be loaded here by JavaScript -->
          </tbody>
        </table>
      </div>
    </section>
    <!-- Edit User Modal -->
    <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-4 sm:p-8 w-full max-w-xs sm:max-w-md relative">
        <button id="closeEditModal" class="absolute top-2 right-2 text-2xl text-green-700">&times;</button>
        <h3 class="text-2xl font-bold text-green-800 mb-4">Edit User</h3>
        <form id="editUserForm">
          <input type="hidden" id="editUserId">
          <div class="mb-4">
            <label class="block text-green-900 mb-2" for="editUserName">Name</label>
            <input class="w-full px-4 py-2 border rounded" type="text" id="editUserName" required>
          </div>
          <div class="mb-4">
            <label class="block text-green-900 mb-2" for="editUserEmail">Email</label>
            <input class="w-full px-4 py-2 border rounded" type="email" id="editUserEmail" required>
          </div>
          <div class="mb-4">
            <label class="block text-green-900 mb-2" for="editUserRole">Role</label>
            <select class="w-full px-4 py-2 border rounded" id="editUserRole" required>
              <option value="farmer">Farmer</option>
              <option value="consumer">Consumer</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-green-700 hover:bg-yellow-400 hover:text-green-900 text-white font-semibold py-3 rounded-full shadow transition text-lg">Save Changes</button>
        </form>
      </div>
    </div>
    <!-- View User Modal -->
    <div id="viewUserModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-4 sm:p-8 w-full max-w-xs sm:max-w-md relative">
        <button id="closeViewModal" class="absolute top-2 right-2 text-2xl text-green-700">&times;</button>
        <h3 class="text-2xl font-bold text-green-800 mb-4">User Details</h3>
        <div id="viewUserDetails"></div>
      </div>
    </div>
      <!-- Order History Section -->
      <section class="mb-10">
        <h3 class="text-2xl font-semibold text-green-800 mb-4">Order History</h3>
        <div class="overflow-x-auto mb-4">
          <table class="min-w-full bg-white rounded shadow">
            <thead>
              <tr class="bg-green-100 text-green-900">
                <th class="py-2 px-4">Order ID</th>
                <th class="py-2 px-4">Consumer</th>
                <th class="py-2 px-4">Farmer</th>
                <th class="py-2 px-4">Crops</th>
                <th class="py-2 px-4">Total</th>
                <th class="py-2 px-4">Status</th>
                <th class="py-2 px-4">Order Type</th>
                <th class="py-2 px-4">Invoice</th>
                <th class="py-2 px-4">Date</th>
              </tr>
            </thead>
            <tbody id="orderHistoryTableBody">
              <!-- Data will be loaded here by JavaScript -->
            </tbody>
          </table>
        </div>
      </section>
      <!-- Contact Messages Section -->
    <section class="mb-10">
      <h3 class="text-2xl font-semibold text-green-800 mb-4">Contact Messages</h3>
      <div class="overflow-x-auto mb-4">
        <table class="min-w-full bg-white rounded shadow">
          <thead>
            <tr class="bg-green-100 text-green-900">
              <th class="py-2 px-4">Name</th>
              <th class="py-2 px-4">Email</th>
              <th class="py-2 px-4">Message</th>
              <th class="py-2 px-4">Date</th>
            </tr>
          </thead>
          <tbody id="contactMessagesTableBody">
            <!-- Data will be loaded here by JavaScript -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-green-800 text-white text-center py-4 mt-auto text-sm sm:text-base">
    Â© 2025 AgriConnect. All rights reserved.
  </footer>
  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-4 sm:p-8 w-full max-w-xs sm:max-w-md relative">
      <button id="closeProfileModal" class="absolute top-2 right-2 text-2xl text-green-700">&times;</button>
      <h3 class="text-2xl font-bold text-green-800 mb-4">My Profile</h3>
      <form id="profileForm">
        <div class="mb-4">
          <label class="block text-green-900 mb-2" for="profileName">Name</label>
          <input class="w-full px-4 py-2 border rounded" type="text" id="profileName" required>
        </div>
        <div class="mb-4">
          <label class="block text-green-900 mb-2" for="profileEmail">Email</label>
          <input class="w-full px-4 py-2 border rounded" type="email" id="profileEmail" required>
        </div>
        <div class="mb-4">
          <label class="block text-green-900 mb-2" for="profilePassword">New Password</label>
          <input class="w-full px-4 py-2 border rounded" type="password" id="profilePassword" placeholder="Leave blank to keep current password">
        </div>
        <button type="submit" class="w-full bg-green-700 hover:bg-yellow-400 hover:text-green-900 text-white font-semibold py-3 rounded-full shadow transition text-lg">Save Changes</button>
      </form>
    </div>
  </div>
  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-8 right-8 bg-green-700 text-white px-6 py-3 rounded shadow-lg z-50 hidden"></div>
  <!-- Invoice Modal -->
  <div id="invoiceModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-4 sm:p-8 w-full max-w-xs sm:max-w-lg relative">
      <button id="closeInvoiceModal" class="absolute top-2 right-2 text-2xl text-green-700">&times;</button>
      <div id="invoiceContent"></div>
      <button id="printInvoiceBtn" class="mt-4 w-full bg-green-700 hover:bg-yellow-400 hover:text-green-900 text-white font-semibold py-2 rounded-full shadow transition text-lg">Print</button>
    </div>
  </div>
  <script>
    async function fetchPendingFarmers() {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch('http://localhost:5000/api/admin/pending-farmers', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const farmers = await res.json();
      const tbody = document.querySelector('#pendingFarmersTableBody');
      tbody.innerHTML = '';
      farmers.forEach(farmer => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 px-4">${farmer.name}</td>
          <td class="py-2 px-4">${farmer.location?.district || ''}, ${farmer.location?.village || ''}</td>
          <td class="py-2 px-4">Pending</td>
          <td class="py-2 px-4">
            <button class="approveFarmerBtn bg-green-700 hover:bg-yellow-400 hover:text-green-900 text-white px-3 py-1 rounded transition mr-2" data-id="${farmer._id}">Approve</button>
            <button class="rejectFarmerBtn bg-red-600 hover:bg-red-400 text-white px-3 py-1 rounded transition" data-id="${farmer._id}">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    async function fetchApprovedFarmers() {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch('http://localhost:5000/api/admin/approved-farmers', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const farmers = await res.json();
      const tbody = document.querySelector('#approvedFarmersTableBody');
      tbody.innerHTML = '';
      farmers.forEach(farmer => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 px-4">${farmer.name}</td>
          <td class="py-2 px-4">${farmer.location?.district || ''}, ${farmer.location?.village || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    let allUsers = [];
    async function fetchAllUsers() {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch('http://localhost:5000/api/admin/consumers', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const consumers = await res.json();
      // Fetch farmers too
      const farmersRes = await fetch('http://localhost:5000/api/admin/approved-farmers', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const farmers = await farmersRes.json();
      allUsers = [...consumers, ...farmers];
      renderUsers(allUsers);
    }
    function renderUsers(users) {
      const tbody = document.querySelector('#manageUsersTableBody');
      tbody.innerHTML = '';
      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 px-4">${user.name}</td>
          <td class="py-2 px-4">${user.email}</td>
          <td class="py-2 px-4">${user.role}</td>
          <td class="py-2 px-4">${user.isActive ? 'Active' : 'Inactive'}</td>
          <td class="py-2 px-4 flex flex-wrap gap-2">
            <button class="viewUserBtn bg-green-100 hover:bg-green-200 text-green-900 px-2 py-1 rounded transition" data-id="${user._id}">View</button>
            <button class="editUserBtn bg-yellow-400 hover:bg-green-700 hover:text-white text-green-900 px-2 py-1 rounded transition" data-id="${user._id}">Edit</button>
            <button class="deleteUserBtn bg-red-600 hover:bg-red-400 text-white px-2 py-1 rounded transition" data-id="${user._id}">Delete</button>
            ${user.isActive
              ? `<button class="deactivateUserBtn bg-yellow-400 hover:bg-green-700 hover:text-white text-green-900 px-2 py-1 rounded transition" data-id="${user._id}">Deactivate</button>`
              : `<button class="activateUserBtn bg-green-700 hover:bg-yellow-400 hover:text-green-900 text-white px-2 py-1 rounded transition" data-id="${user._id}">Activate</button>`}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    // Search/filter logic
    document.getElementById('userSearchInput').addEventListener('input', function(e) {
      filterAndRenderUsers();
    });
    document.getElementById('userRoleFilter').addEventListener('change', function(e) {
      filterAndRenderUsers();
    });
    function filterAndRenderUsers() {
      const search = document.getElementById('userSearchInput').value.toLowerCase();
      const role = document.getElementById('userRoleFilter').value;
      let filtered = allUsers;
      if (search) {
        filtered = filtered.filter(u => u.name.toLowerCase().includes(search) || u.email.toLowerCase().includes(search));
      }
      if (role) {
        filtered = filtered.filter(u => u.role === role);
      }
      renderUsers(filtered);
    }
    async function fetchAdminOrders() {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch('http://localhost:5000/api/orders', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const orders = await res.json();
      const tbody = document.getElementById('orderHistoryTableBody');
      tbody.innerHTML = '';
      orders.forEach((order, idx) => {
        const cropsList = order.crops.map(c => `${c.crop?.name || ''} (${c.quantity} kg)`).join(', ');
        tbody.innerHTML += `
          <tr>
            <td class='py-2 px-4'>${order._id}</td>
            <td class='py-2 px-4'>${order.consumer?.name || ''}</td>
            <td class='py-2 px-4'>${order.farmer?.name || ''}</td>
            <td class='py-2 px-4'>${cropsList}</td>
            <td class='py-2 px-4'>â‚¹${order.totalAmount}</td>
            <td class='py-2 px-4'>${order.status}</td>
            <td class='py-2 px-4'>${order.orderType || ''}</td>
            <td class='py-2 px-4'><button class="downloadInvoiceBtn bg-green-700 hover:bg-yellow-400 hover:text-green-900 text-white px-3 py-1 rounded-full text-xs" data-idx="${idx}">Download Invoice</button></td>
            <td class='py-2 px-4'>${order.createdAt ? new Date(order.createdAt).toLocaleString() : ''}</td>
          </tr>
        `;
      });
    }
    document.addEventListener('DOMContentLoaded', function() {
      fetchPendingFarmers();
      fetchApprovedFarmers();
      fetchAllUsers();
      fetchPendingCrops();
      fetchAvailableCrops();
      fetchAnalytics();
      fetchContactMessages();
      fetchAdminOrders();
      setInterval(() => {
        fetchPendingFarmers();
        fetchApprovedFarmers();
        fetchAllUsers();
        fetchPendingCrops();
        fetchAvailableCrops();
        fetchAnalytics();
        fetchContactMessages();
        fetchAdminOrders();
      }, 10000);
    });
    document.addEventListener('click', async function(e) {
      // Edit user
      if (e.target.classList.contains('editUserBtn')) {
        const id = e.target.getAttribute('data-id');
        const user = allUsers.find(u => u._id === id);
        if (!user) return;
        document.getElementById('editUserId').value = user._id;
        document.getElementById('editUserName').value = user.name;
        document.getElementById('editUserEmail').value = user.email;
        document.getElementById('editUserRole').value = user.role;
        document.getElementById('editUserModal').classList.remove('hidden');
      }
      // Delete user
      if (e.target.classList.contains('deleteUserBtn')) {
        const id = e.target.getAttribute('data-id');
        const token = localStorage.getItem('token');
        if (!token) return;
        if (!confirm('Are you sure you want to delete this user?')) return;
        const res = await fetch(`http://localhost:5000/api/admin/delete-user/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
          showToast('User deleted!');
          fetchAllUsers();
        } else {
          showToast('Failed to delete user.', 'bg-red-600');
        }
      }
      // View user
      if (e.target.classList.contains('viewUserBtn')) {
        const id = e.target.getAttribute('data-id');
        const user = allUsers.find(u => u._id === id);
        if (!user) return;
        document.getElementById('viewUserDetails').innerHTML = `
          <div><b>Name:</b> ${user.name}</div>
          <div><b>Email:</b> ${user.email}</div>
          <div><b>Role:</b> ${user.role}</div>
          <div><b>Status:</b> ${user.isActive ? 'Active' : 'Inactive'}</div>
          <div><b>Location:</b> ${user.location ? `${user.location.district || ''}, ${user.location.village || ''}` : ''}</div>
          <div><b>Registered:</b> ${user.createdAt ? new Date(user.createdAt).toLocaleString() : ''}</div>
        `;
        document.getElementById('viewUserModal').classList.remove('hidden');
      }
      // Activate/Deactivate logic (existing)
      if (e.target.classList.contains('deactivateUserBtn')) {
        const id = e.target.getAttribute('data-id');
        const token = localStorage.getItem('token');
        if (!token) return;
        const res = await fetch(`http://localhost:5000/api/admin/deactivate-user/${id}`, {
          method: 'PATCH',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
          showToast('User deactivated!');
          fetchAllUsers();
        } else {
          showToast('Failed to deactivate user.', 'bg-red-600');
        }
      }
      if (e.target.classList.contains('activateUserBtn')) {
        const id = e.target.getAttribute('data-id');
        const token = localStorage.getItem('token');
        if (!token) return;
        const res = await fetch(`http://localhost:5000/api/admin/activate-user/${id}`, {
          method: 'PATCH',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
          showToast('User activated!');
          fetchAllUsers();
        } else {
          showToast('Failed to activate user.', 'bg-red-600');
        }
      }
    });
    // Edit user modal logic
    document.getElementById('closeEditModal').onclick = function() {
      document.getElementById('editUserModal').classList.add('hidden');
    };
    document.getElementById('editUserForm').onsubmit = async function(e) {
      e.preventDefault();
      const id = document.getElementById('editUserId').value;
      const name = document.getElementById('editUserName').value;
      const email = document.getElementById('editUserEmail').value;
      const role = document.getElementById('editUserRole').value;
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch(`http://localhost:5000/api/admin/edit-user/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ name, email, role })
      });
      if (res.ok) {
        showToast('User updated!');
        document.getElementById('editUserModal').classList.add('hidden');
        fetchAllUsers();
      } else {
        showToast('Failed to update user.', 'bg-red-600');
      }
    };
    // View user modal logic
    document.getElementById('closeViewModal').onclick = function() {
      document.getElementById('viewUserModal').classList.add('hidden');
    };

    async function fetchPendingCrops() {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch('http://localhost:5000/api/crops?isApproved=false', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const crops = await res.json();
      const tbody = document.querySelector('#pendingCropsTableBody');
      tbody.innerHTML = '';
      crops.forEach(crop => {
        const backendUrl = "http://localhost:5000";
        let photo = (crop.photos && crop.photos[0])
          ? (
              /^(https?:)?\/\//.test(crop.photos[0])
                ? crop.photos[0]
                : crop.photos[0].startsWith('/uploads/')
                  ? backendUrl + crop.photos[0]
                  : crop.photos[0].includes('.') && !crop.photos[0].startsWith('/')
                    ? 'https://' + crop.photos[0]
                    : backendUrl + crop.photos[0]
            )
          : 'https://via.placeholder.com/40';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 px-4"><img src="${photo}" alt="Crop" class="rounded h-12 w-12 object-cover"></td>
          <td class="py-2 px-4">${crop.name}</td>
          <td class="py-2 px-4">${crop.farmer?.name || ''}</td>
          <td class="py-2 px-4">Pending</td>
          <td class="py-2 px-4">
            <button class="approveCropBtn bg-green-700 hover:bg-yellow-400 hover:text-green-900 text-white px-3 py-1 rounded transition mr-2" data-id="${crop._id}">Approve</button>
            <button class="rejectCropBtn bg-red-600 hover:bg-red-400 text-white px-3 py-1 rounded transition" data-id="${crop._id}">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    document.addEventListener('DOMContentLoaded', fetchPendingCrops);
    document.addEventListener('click', async function(e) {
      if (e.target.classList.contains('approveCropBtn')) {
        const id = e.target.getAttribute('data-id');
        const token = localStorage.getItem('token');
        if (!token) return;
        const res = await fetch(`http://localhost:5000/api/crops/${id}/approve`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ isApproved: true })
        });
        if (res.ok) {
          showToast('Crop approved!');
          fetchPendingCrops();
        } else {
          showToast('Failed to approve crop.', 'bg-red-600');
        }
      }
      if (e.target.classList.contains('rejectCropBtn')) {
        const id = e.target.getAttribute('data-id');
        const token = localStorage.getItem('token');
        if (!token) return;
        if (!confirm('Are you sure you want to reject and delete this crop?')) return;
        const res = await fetch(`http://localhost:5000/api/crops/${id}/reject`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
          showToast('Crop rejected and deleted!');
          fetchPendingCrops();
        } else {
          showToast('Failed to reject crop.', 'bg-red-600');
        }
      }
    });

    async function fetchAnalytics() {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch('http://localhost:5000/api/admin/analytics', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      document.querySelector('.summary-users').textContent = data.totalUsers;
      document.querySelector('.summary-farmers').textContent = data.totalFarmers;
      document.querySelector('.summary-orders').textContent = data.totalOrders;
      document.querySelector('.summary-revenue').textContent = 'â‚¹' + data.totalRevenue;
    }
    document.addEventListener('DOMContentLoaded', fetchAnalytics);

    document.getElementById('logoutBtn').onclick = function() {
      localStorage.clear();
      window.location.href = 'login.html';
    };

    // Profile modal logic
    const profileBtn = document.createElement('button');
    profileBtn.textContent = 'Profile';
    profileBtn.className = 'ml-4 bg-green-100 hover:bg-green-200 text-green-900 px-4 py-2 rounded transition';
    profileBtn.onclick = function() {
      const token = localStorage.getItem('token');
      if (!token) return;
      fetch('http://localhost:5000/api/users/me', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(user => {
        document.getElementById('profileName').value = user.name;
        document.getElementById('profileEmail').value = user.email;
        document.getElementById('profilePassword').value = '';
        document.getElementById('profileModal').classList.remove('hidden');
      });
    };
    document.querySelector('nav ul').appendChild(profileBtn);
    document.getElementById('closeProfileModal').onclick = function() {
      document.getElementById('profileModal').classList.add('hidden');
    };
    document.getElementById('profileForm').onsubmit = async function(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');
      if (!token) return;
      const name = document.getElementById('profileName').value;
      const email = document.getElementById('profileEmail').value;
      const password = document.getElementById('profilePassword').value;
      const res = await fetch('http://localhost:5000/api/users/me', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ name, email, password: password || undefined })
      });
      if (res.ok) {
        showToast('Profile updated!');
        document.getElementById('profileModal').classList.add('hidden');
      } else {
        showToast('Failed to update profile.', 'bg-red-600');
      }
    };

    async function fetchAvailableCrops() {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch('http://localhost:5000/api/crops?isApproved=true', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const crops = await res.json();
      const tbody = document.querySelector('#availableCropsTableBody');
      tbody.innerHTML = '';
      crops.forEach(crop => {
        const backendUrl = "http://localhost:5000";
        let photo = (crop.photos && crop.photos[0])
          ? (
              /^(https?:)?\/\//.test(crop.photos[0])
                ? crop.photos[0]
                : crop.photos[0].startsWith('/uploads/')
                  ? backendUrl + crop.photos[0]
                  : crop.photos[0].includes('.') && !crop.photos[0].startsWith('/')
                    ? 'https://' + crop.photos[0]
                    : backendUrl + crop.photos[0]
            )
          : 'https://via.placeholder.com/40';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 px-4"><img src="${photo}" alt="Crop" class="rounded h-12 w-12 object-cover"></td>
          <td class="py-2 px-4">${crop.name}</td>
          <td class="py-2 px-4">${crop.farmer?.name || ''}</td>
          <td class="py-2 px-4">${crop.quantity || ''}</td>
          <td class="py-2 px-4">
            ${crop.discountPercent ? `<span class='line-through text-red-500 mr-2'>â‚¹${crop.price}/kg</span><span class='text-green-700 font-bold'>â‚¹${(crop.price * (1 - crop.discountPercent / 100)).toFixed(2)}/kg (${crop.discountPercent}% off)</span>` : `â‚¹${crop.price}/kg`}
          </td>
          <td class="py-2 px-4">${crop.isApproved ? 'Approved' : 'Pending'}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    document.addEventListener('DOMContentLoaded', fetchAvailableCrops);

    async function fetchContactMessages() {
      const res = await fetch('http://localhost:5000/api/contact');
      const messages = await res.json();
      const tbody = document.querySelector('#contactMessagesTableBody');
      tbody.innerHTML = '';
      messages.forEach(msg => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 px-4">${msg.name}</td>
          <td class="py-2 px-4">${msg.email}</td>
          <td class="py-2 px-4">${msg.message}</td>
          <td class="py-2 px-4">${msg.createdAt ? new Date(msg.createdAt).toLocaleString() : ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    document.addEventListener('DOMContentLoaded', fetchContactMessages);

    function showToast(msg, color = 'bg-green-700') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = `fixed bottom-8 right-8 ${color} text-white px-6 py-3 rounded shadow-lg z-50`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2000);
    }

    // Invoice modal logic for admin
    let adminOrdersCache = [];
    const origFetchAdminOrders = fetchAdminOrders;
    fetchAdminOrders = async function() {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch('http://localhost:5000/api/orders', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const orders = await res.json();
      adminOrdersCache = orders;
      const tbody = document.getElementById('orderHistoryTableBody');
      tbody.innerHTML = '';
      orders.forEach((order, idx) => {
        const cropsList = order.crops.map(c => `${c.crop?.name || ''} (${c.quantity} kg)`).join(', ');
        tbody.innerHTML += `
          <tr>
            <td class='py-2 px-4'>${order._id}</td>
            <td class='py-2 px-4'>${order.consumer?.name || ''}</td>
            <td class='py-2 px-4'>${order.farmer?.name || ''}</td>
            <td class='py-2 px-4'>${cropsList}</td>
            <td class='py-2 px-4'>â‚¹${order.totalAmount}</td>
            <td class='py-2 px-4'>${order.status}</td>
            <td class='py-2 px-4'>${order.orderType || ''}</td>
            <td class='py-2 px-4'><button class="downloadInvoiceBtn bg-green-700 hover:bg-yellow-400 hover:text-green-900 text-white px-3 py-1 rounded-full text-xs" data-idx="${idx}">Download Invoice</button></td>
            <td class='py-2 px-4'>${order.createdAt ? new Date(order.createdAt).toLocaleString() : ''}</td>
          </tr>
        `;
      });
    }
    document.getElementById('orderHistoryTableBody').addEventListener('click', function(e) {
      if (e.target.classList.contains('downloadInvoiceBtn')) {
        const idx = e.target.getAttribute('data-idx');
        showInvoiceModal(idx);
      }
    });
    function showInvoiceModal(idx) {
      const order = adminOrdersCache[idx];
      const cropsHtml = order.crops.map(c => `<tr><td>${c.crop?.name || ''}</td><td>${c.quantity} kg</td><td>â‚¹${c.crop?.price || ''}</td><td>â‚¹${(c.crop?.price || 0) * c.quantity}</td></tr>`).join('');
      document.getElementById('invoiceContent').innerHTML = `
        <div class='rounded-lg border-4 border-green-700 p-6 bg-white shadow-lg'>
          <div class='flex items-center mb-2'>
            <img src='icon.jpg' alt='AgriConnect Logo' class='h-14 w-14 mr-4 rounded-full' style='display:inline-block;vertical-align:middle;'>
            <div>
              <span class='text-4xl font-extrabold text-green-800' style='vertical-align:middle;'>AgriConnect</span><br>
              <span class='text-lg text-green-700 font-semibold'>Bridging Farmers and Consumers for a Sustainable Future</span>
            </div>
          </div>
          <hr class='my-3 border-green-300'>
          <h3 class='text-2xl font-bold text-green-800 mb-2 text-center'>Order Invoice</h3>
          <div class='mb-2 text-green-900'><b>Date:</b> ${order.createdAt ? new Date(order.createdAt).toLocaleString() : ''}</div>
          <div class='mb-2 text-green-900'><b>Order ID:</b> ${order._id}</div>
          <div class='mb-2 text-green-900'><b>Consumer:</b> ${order.consumer?.name || ''}</div>
          <div class='mb-2 text-green-900'><b>Farmer:</b> ${order.farmer?.name || ''}</div>
          <div class='mb-2 text-green-900'><b>Status:</b> ${order.status}</div>
          <div class='mb-2 text-green-900'><b>Order Type:</b> ${order.orderType || ''}</div>
          <table class='w-full text-green-900 mb-2 border border-green-200 rounded'><thead><tr class='bg-green-100'><th>Crop</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>${cropsHtml}</tbody></table>
          <div class='text-right text-xl font-bold text-green-800 mb-4'>Total: â‚¹${order.totalAmount}</div>
          <div class='text-center text-green-800 font-semibold mt-6 mb-2'>Thank you for supporting local farmers!</div>
          <div class='text-center text-green-600 text-sm'>&copy; 2025 AgriConnect. All rights reserved.</div>
        </div>
      `;
      document.getElementById('invoiceModal').classList.remove('hidden');
    }
    document.getElementById('closeInvoiceModal').onclick = function() {
      document.getElementById('invoiceModal').classList.add('hidden');
    };
    document.getElementById('printInvoiceBtn').onclick = function() {
      const printContents = document.getElementById('invoiceContent').innerHTML;
      const win = window.open('', '', 'width=800,height=600');
      win.document.write('<html><head><title>Order Invoice</title><link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"></head><body>' + printContents + '</body></html>');
      win.document.close();
      win.print();
    };
  </script>
</body>
</html> 